/*!
 * Torro Forms Version 1.0.0alpha1 (http://torro-forms.com)
 * Licensed under GNU General Public License v3 (http://www.gnu.org/licenses/gpl-3.0.html)
 */
!function(e,t,n,i){"use strict";function r(e){this.translations=e,this.extensions={},this.selectors={containers:"#containers",container_id:'input[name="container_id"]',container_add:"#container-add",container_tab:".tab-container",container_tabs:".container-tabs",draggable_item:"#form-elements .formelement",droppable_area:".torro-drag-drop-inside",element:".formelement",drop_elements_here:".drop-elements-here",delete_container_button:".delete-container-button",delete_container_dialog:"#delete_container_dialog",delete_element_button:".delete_form_element",delete_element_dialog:"#delete_formelement_dialog",deleted_containers:"#deleted_containers",deleted_elements:"#deleted_formelements",answers_sub:".answers",answer_sub:".answer",add_answer_button:".add-answer",delete_answer_button:".delete_answer",delete_answer_dialog:"#delete_answer_dialog",deleted_answers:"#deleted_answers",tabs:".tabs",element_form_label:".form-label",duplicate_form_button:"#form-duplicate-button",delete_results_button:"#form-delete-results",delete_results_dialog:"#delete_results_dialog"}}r.prototype={init:function(){this.init_drag_and_drop(),this.init_container_deletion(),this.init_formelement_deletion(),this.init_sortable_answers(),this.init_container_addition(),this.init_answer_addition(),this.init_answer_deletion(),this.init_answer_enter(),this.init_tab_handling(),this.init_element_title_rewrite(),this.init_form_duplication(),this.init_results_deletion(),this.init_clipboard(),this.init_form_redirections(),this.init_access_controls(),this.check_max_input_vars(),this.init_container_tabs()},load_ajax_editor:function(e,n,i,r){if(!(e.length<1)){r||(r="");var o=this;t.ajax.post("torro_get_editor_html",{nonce:this.translations.nonce_get_editor_html,element_id:n,field_name:i,message:r}).done(function(t){e.html(t.html),o.init_ajax_editor(t)}).fail(function(e){console.error(e)})}},init_ajax_editor:function(e){if(window.tinymce&&window.quicktags&&window.tinyMCEPreInit){var t=Object.keys(window.tinyMCEPreInit.mceInit)[0];window.tinyMCEPreInit.mceInit[e.editor_id]=n.extend({},window.tinyMCEPreInit.mceInit[t],e.tinymce),window.tinyMCEPreInit.qtInit[e.editor_id]=e.quicktags,window.QTags.instances[0]=!1,window.tinymce.init(window.tinyMCEPreInit.mceInit[e.editor_id]),window.quicktags(window.tinyMCEPreInit.qtInit[e.editor_id])}},init_drag_and_drop:function(){function e(e){e.each(function(e,i){0==n(i).find(t.selectors.element).length&&n(i).find(t.selectors.drop_elements_here).show()}),e.droppable({accept:t.selectors.draggable_item}).sortable({placeholder:"form-element-placeholder",items:t.selectors.element,handle:".widget-top",start:function(e,t){var n=t.item;n.find("textarea.wp-editor-area").each(function(e,t){if("undefined"!=typeof window.tinyMCEPreInit.mceInit[t.id]){var n=tinymce.get(t.id);n&&(n.save(),tinymce.execCommand("mceRemoveEditor",!0,t.id))}})},stop:function(e,t){var i=t.item;i.find("textarea.wp-editor-area").each(function(e,t){if("undefined"!=typeof window.tinyMCEPreInit.mceInit[t.id]){var i=tinymce.get(t.id);i||(tinymce.execCommand("mceAddEditor",!0,t.id),n("#wp-"+t.id+"-wrap").hasClass("html-active")&&n("#"+t.id+"-html").trigger("click"))}})},update:function(i,r){var o=r.item,a=n(this).parent().find(t.selectors.container_id).val();if(!o.attr("id")){var s=t.generate_temp_id();if(o.attr("id","element-"+s),o.attr("data-element-id",s),o.html(o.html().replace(/replace_element_id/g,s)),o.html(o.html().replace(/replace_container_id/g,a)),e.trigger("torro.element_dropped",{element:o}),o.data("element-type")){var l={id:s,selector:"#element-"+s,container_id:a};n(document).trigger("torro.insert_element_"+o.data("element-type"),[l])}}n("#torro-container-"+a+" "+t.selectors.droppable_area+" "+t.selectors.element).each(function(e){var i=n(this).attr("data-element-id");t.generate_admin_input_name(a,i,void 0,"container_id",!0),n('input[name^="'+t.generate_admin_input_name(a,i,void 0,"container_id",!0)+'"]').val(a),n('input[name^="'+t.generate_admin_input_name(a,i,void 0,"sort",!0)+'"]').val(e),n('input[name^="'+t.generate_admin_input_name(a,i,void 0,"id",!0)+'"]').val(i)})}}),e.on("torro.element_dropped",function(e,n){t.check_max_input_vars()})}var t=this;n(document).on("torro.insert_element_content",function(e,i){n(i.selector);t.load_ajax_editor(n(i.selector).find(".torro-element-content"),i.id,t.generate_admin_input_name(i.container_id,i.id,void 0,"label"))}),n(this.selectors.draggable_item).draggable({helper:"clone",cursor:"move",connectToSortable:this.selectors.droppable_area,handle:".widget-top",addClasses:!1,start:function(e,t){var n=t.helper;n.css("height","auto").css("width","100px")},stop:function(e,n){var i=n.helper,r=i.closest(".torro-container");r.find(t.selectors.drop_elements_here).hide(),i.css("width","100%").css("height","auto"),i.addClass("widget")}}),e(n(t.selectors.droppable_area)),n(document).on("torro.insert_container",function(i,r){e(n(r.container_selector+" "+t.selectors.droppable_area))})},init_container_tabs:function(){function e(e){e.on("dblclick",function(){n(this).find("input").toggle().val(n(this).find("a").html()).focus(),n(this).find("a").toggle()}),e.on("keydown blur dblclick","input",function(e){if("keydown"==e.type){if(13==e.which){n(this).toggle(),n(this).siblings("a").toggle().html(n(this).val());var i=n(this).val(),r=n(this).parent().find("a").attr("href"),o=n(r+" input[name=container_id]").val();n('input[name^="'+t.generate_admin_input_name(o,void 0,void 0,"label",!0)+'"]').val(i)}38!=e.which&&40!=e.which&&37!=e.which&&39!=e.which&&32!=e.keyCode||e.stopPropagation()}else if("focusout"==e.type){n(this).toggle(),n(this).siblings("a").toggle().html(n(this).val());var i=n(this).val(),r=n(this).parent().find("a").attr("href"),o=n(r+" input[name=container_id]").val();n('input[name^="'+t.generate_admin_input_name(o,void 0,void 0,"label",!0)+'"]').val(i)}else e.stopPropagation()})}var t=this;n(t.selectors.container_tabs).parent().tabs(),n(t.selectors.container_tabs).sortable({items:t.selectors.container_tab,stop:function(e,i){i.item.parent().find("li").each(function(e,i){var r=n(i).find("a").attr("href");if(void 0!=r){var o=n(r+" input[name=container_id]").val();t.generate_admin_input_name(o,void 0,void 0,"sort",!0),n('input[name^="'+t.generate_admin_input_name(o,void 0,void 0,"sort",!0)+'"]').val(e)}}),n(t.selectors.container_tabs).parent().tabs("refresh")}}),e(n(t.selectors.container_tab)),n(document).on("torro.insert_container",function(t,i){e(n(i.tab_selector))})},init_container_deletion:function(){var e=this,t=n(this.selectors.delete_container_dialog);t.dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,minHeight:80,buttons:[{text:this.translations.yes,click:function(){if(e.current_container_id){if(!e.is_temp_id(e.current_container_id)){var t=n(e.selectors.deleted_containers).val();t+=""==t?e.current_container_id:","+e.current_container_id,n(e.selectors.deleted_containers).val(t)}var i="tab-container-"+e.current_container_id,r="torro-container-"+e.current_container_id,o=n("#"+i).index();0==o?o=0:o-=1,n("#"+i).remove(),n("#"+r).remove(),n(e.selectors.container_tabs).parent().tabs("refresh"),n(e.selectors.container_tabs).parent().tabs("option","active",o),e.current_container_id="";var a={tab_id:i,tab_selector:"#"+i,container_id:r,container_selector:"#"+r};n(document).trigger("torro.delete_container",[a])}n(this).dialog("close")}},{text:this.translations.no,click:function(){n(this).dialog("close")}}]}),n(this.selectors.containers).on("click",this.selectors.delete_container_button,function(i){i.preventDefault(),e.current_container_id=n(this).parent().parent().find(e.selectors.container_id).val(),t.dialog("open")})},init_formelement_deletion:function(){var e=this,t=n(this.selectors.delete_element_dialog);t.dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,minHeight:80,buttons:[{text:this.translations.yes,click:function(){if(e.current_element_id){if(!e.is_temp_id(e.current_element_id)){var t=n(e.selectors.deleted_elements).val();t+=""==t?e.current_element_id:","+e.current_element_id,n(e.selectors.deleted_elements).val(t)}var i=n("#element-"+e.current_element_id).parents(".torro-container");if(n("#element-"+e.current_element_id).remove(),i.find(e.selectors.droppable_area+" "+e.selectors.element).length<1&&i.find(e.selectors.drop_elements_here).show(),e.current_element_type){var r={id:"element-"+e.current_element_id,selector:"#element-"+e.current_element_id};n(document).trigger("torro.delete_element_"+e.current_element_type,[r])}}n(this).dialog("close")}},{text:this.translations.no,click:function(){n(this).dialog("close")}}]}),n(document).on("click",this.selectors.delete_element_button,function(i){i.preventDefault(),e.current_element_id=n(this).closest(e.selectors.element).attr("data-element-id"),e.current_element_type=n(this).closest(e.selectors.element).attr("data-element-type"),t.dialog("open")})},init_sortable_answers:function(){function e(e){function i(e){e.sortable({update:function(e,i){var r=n(this).closest(".torro-container").attr("id"),o=n(this).closest(".widget").attr("id");return r&&o?(r=r.replace("torro-container-",""),o=o.replace("element-",""),void n(this).find(t.selectors.answer_sub).each(function(e){var i=n(this).attr("id");i=i.split("_"),i=i[1];var a='input[name="'+t.generate_admin_input_name(r,o,"id_"+i,"sort",!0)+'"]',s=n(this).index();n(a).val(s)})):void console.error("Error: Missing element or container ID!")},items:t.selectors.answer_sub})}i(e.find(t.selectors.answers_sub)),e.on("torro.element_dropped",function(e,n){var r=n.element;i(r.find(t.selectors.answers_sub))})}var t=this;e(n(this.selectors.droppable_area)),n(document).on("torro.insert_container",function(i,r){e(n(r.container_selector+" "+t.selectors.droppable_area))})},init_container_addition:function(){var e=this;n(this.selectors.container_add).on("click",function(){var t=n(e.selectors.container_tabs).parent().find(".torro-container").length,i=e.generate_temp_id(),r="torro-container-"+i,o="tab-container-"+i,a='<li id="'+o+'" class="tab-container"><input class="txt" type="text"/><a href="#'+r+'">'+e.translations.page+" "+(t+1)+"</a></li>",s='<div id="'+r+'" class="torro-container">';s+='<div class="torro-drag-drop-inside">',s+='<div class="drop-elements-here">'+e.translations.drop_elements_here+"</div>",s+="</div>",s+='<div class="container-buttons">',s+='<input type="button" name="delete_container" value="'+e.translations.delete_page+'" class="button delete-container-button" />',s+="</div>",s+='<input type="hidden" name="container_id" value="'+i+'" />',s+='<input type="hidden" name="'+e.generate_admin_input_name(r,void 0,void 0,"id")+'" value="'+i+'" />',s+='<input type="hidden" name="'+e.generate_admin_input_name(r,void 0,void 0,"label")+'" value="Page '+(t+1)+'" />',s+='<input type="hidden" name="'+e.generate_admin_input_name(r,void 0,void 0,"sort")+'" value="'+t+'" />',s+="</div>",n(a).insertBefore(this),n(e.selectors.container_tabs).parent().append(s),n(e.selectors.container_tabs).parent().tabs("refresh");var l=n(e.selectors.container_tabs+" li:last-child").parent().index()-1;n(e.selectors.container_tabs).parent().tabs("option","active",l);var c={tab_id:o,tab_selector:"#"+o,container_id:r,container_selector:"#"+r};n(document).trigger("torro.insert_container",[c])})},init_answer_addition:function(){var e=this;n(document).on("click",this.selectors.add_answer_button,function(){var t=n(this),i=t.attr("data-container-id"),r=t.attr("data-element-id");if(!i||!r)return void console.error("Error: Missing element or container ID!");var o=e.generate_temp_id(),a=n('input[name="'+e.generate_admin_input_name(i,r,void 0,"sections",!0)+'"]').val(),s='<div class="answer" id="answer_'+o+'">';if(s=s+'<p><input type="text" id="answer_'+o+'_input" name="'+e.generate_admin_input_name(i,r,o,"answer")+'" class="element-answer" /></p>',s=s+'<input type="hidden" name="'+e.generate_admin_input_name(i,r,o,"id")+'" />',s=s+'<input type="hidden" name="'+e.generate_admin_input_name(i,r,o,"sort")+'" />',"yes"==a){var l=t.parent().find('input[name="section_key"]').val();s=s+'<input type="hidden" name="'+e.generate_admin_input_name(i,r,o,"section")+'" value="'+l+'" />'}s=s+' <input type="button" value="'+e.translations["delete"]+'" class="delete_answer button answer_action"></div>';var c=0;if(t.parent().find(".answer").each(function(e){c++}),"yes"==a)var d="#element-"+r+" #section_"+l+" "+e.selectors.answers_sub;else var d="#element-"+r+" "+e.selectors.answers_sub;n(d).append(s);var _=n("#answer_"+o+"_input");_.focus(),n('input[name="'+e.generate_admin_input_name(i,r,"id_"+o,"sort",!0)+'"]').val(c)})},init_answer_deletion:function(){var e=this,t=n(this.selectors.delete_answer_dialog);t.dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,minHeight:80,buttons:[{text:this.translations.yes,click:function(){if(e.current_answer_id){if(e.current_answer_id=e.current_answer_id.substring(7),!e.is_temp_id(e.current_answer_id)){var t=n(e.selectors.deleted_answers).val();t+=""==t?e.current_answer_id:","+e.current_answer_id,n(e.selectors.deleted_answers).val(t)}n("#answer_"+e.current_answer_id).remove(),e.current_answer_id=""}n(this).dialog("close")}},{text:this.translations.no,click:function(){n(this).dialog("close")}}]}),n(document).on("click",this.selectors.delete_answer_button,function(i){i.preventDefault(),e.current_answer_id=n(this).closest(".answer").attr("id"),t.dialog("open")})},init_answer_enter:function(){var e=this;n(document).on("keydown",".element-answer",function(t){if(13===t.keyCode){t.preventDefault();var i=n(this).parents(e.selectors.tabs).find(e.selectors.add_answer_button);i.trigger("click")}})},init_tab_handling:function(){function e(e){function n(e){e.tabs({active:0})}n(e.find(t.selectors.tabs)),e.on("torro.element_dropped",function(e,i){var r=i.element;n(r.find(t.selectors.tabs))})}var t=this;n(t.selectors.tabs).tabs({active:0}),e(n(this.selectors.droppable_area)),n(document).on("torro.insert_container",function(i,r){e(n(r.container_selector+" "+t.selectors.droppable_area))})},init_element_title_rewrite:function(){n(this.selectors.droppable_area).on("input",this.selectors.element_form_label,function(){var e=n(this).closest(".widget").attr("id");n("#"+e+" .widget-title h4").text(n(this).val())})},init_form_duplication:function(){var e=this;n(this.selectors.duplicate_form_button).on("click",function(){var i=n(this);i.hasClass("button")?(i.addClass("button-loading"),t.ajax.post("torro_duplicate_form",{nonce:e.translations.nonce_duplicate_form,form_id:e.get_form_id()}).done(function(t){var r=e.translations.duplicated_form_successfully+' <a href="'+t.admin_url+'">'+e.translations.edit_form+"</a>",o=n("#form-options .notices");o.html(r),o.show(),i.removeClass("button-loading"),o.fadeOut(5e3)}).fail(function(e){console.error(e)})):i.addClass("button")})},init_results_deletion:function(){var e=this;n(this.selectors.delete_results_button).on("click",function(){var i=n(this);if(i.hasClass("button")){var r=n(e.selectors.delete_results_dialog);r.dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,minHeight:80,buttons:[{text:e.translations.yes,click:function(){n(this).dialog("close"),i.addClass("button-loading"),t.ajax.post("torro_delete_responses",{nonce:e.translations.nonce_delete_responses,form_id:e.get_form_id()}).done(function(t){n(document).trigger("torro.delete_results",[t]),n("#form-functions-notices").html(e.translations.deleted_results_successfully),n("#form-functions-notices").show(),i.removeClass("button-loading"),n("#form-functions-notices").fadeOut(5e3)}).fail(function(e){console.error(e)})}},{text:e.translations.no,click:function(){n(this).dialog("close")}}]}),r.dialog("open")}else i.addClass("button")})},init_clipboard:function(){var e=this,t=new Clipboard(".clipboard");t.on("success",function(t){var n=t.trigger;t.clearSelection(),n.setAttribute("class","clipboard tooltipped tooltipped-s button"),n.setAttribute("aria-label",e.translations.copied)});for(var n=document.querySelectorAll(".clipboard"),i=0;i<n.length;i++)n[i].addEventListener("mouseleave",function(e){e.currentTarget.setAttribute("class","clipboard button"),e.currentTarget.removeAttribute("aria-label")})},init_form_redirections:function(){var e=function(){n(".redirect-content").hide(),n("#"+n("#redirect_type").val()).show()};e(),n(document).on("change","#redirect_type",function(){e()})},init_access_controls:function(){var e=function(){n(".form-access-controls-content").hide(),n("#form-access-controls-content-"+n("#form-access-controls-option").val()).show()};e(),n(document).on("change","#form-access-controls-option",function(){e()})},check_max_input_vars:function(){var e=parseInt(n("#max_input_vars").val()),t=parseInt(this.count_form_elements("#post")),i=50,r="<strong>"+this.translations.max_fields_near_limit+"</strong> ("+t+" "+this.translations.of+" "+e+")<br /> "+this.translations.max_fields_todo,o="<strong>"+this.translations.max_fields_over_limit+"</strong> ("+t+" "+this.translations.of+" "+e+")<br /> "+this.translations.max_fields_todo;t+i>=e&&n("#form-messages").removeClass("notice error updated").addClass("notice").html("<p>"+r+"</p>").show(),t>=e&&n("#form-messages").removeClass("notice error updated").addClass("error").html("<p>"+o+"</p>").show()},count_form_elements:function(e){var t=n(e).find("input").length,i=n(e).find("textarea").length,r=n(e).find("select").length,o=t+i+r;return o},get_form_id:function(){return n("#post_ID").val()},init_extensions:function(){var e=Object.keys(this.extensions);for(var t in e)this.extensions[e[t]].init()},add_extension:function(e,t){this.extensions[e]=t},get_extension:function(e){return this.extensions[e]},get_extensions:function(){return this.extensions},generate_admin_input_name:function(e,t,n,i,r){if(!e)return"";var o="containers["+e+"]";return t&&(o+="[elements]["+t+"]"),n&&(o+="[answers]["+n+"]"),i&&(o+="["+i+"]"),r&&(o=o.replace("[","[").replace("]","]")),o},generate_temp_id:function(){var e=new Date,t=Math.floor(9991*Math.random())+10;return t*=e.getTime(),t=t.toString(),("temp_id_"+t).substring(0,14)},is_temp_id:function(e){return"temp_id"===e.substring(0,7)}};var o=new r(i);n(document).ready(function(){o.init(),o.init_extensions()}),e.form_builder=o}(window,wp,jQuery,translation_fb);